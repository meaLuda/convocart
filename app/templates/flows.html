{% extends "base.html" %}

{% block title %}Flow Management | WhatsApp Order Bot{% endblock %}

{% block page_title %}Flow Management{% endblock %}

{% block content %}
    <!-- Group Filter -->
    <div class="card mb-6">
        <div class="flex flex-wrap items-center gap-4">
            <label class="font-medium text-gray-700">Filter by Group:</label>
            <select id="groupFilter" class="form-select" onchange="filterFlows()">
                <option value="">All Groups</option>
                {% for group in groups %}
                <option value="{{ group.id }}" {{ 'selected' if selected_group_id == group.id else '' }}>
                    {{ group.name }}
                </option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- Flows List -->
    <div class="card">
        {% if flows %}
        <div class="overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border p-3 text-left">Name</th>
                        <th class="border p-3 text-left">Group</th>
                        <th class="border p-3 text-left">Status</th>
                        <th class="border p-3 text-left">States</th>
                        <th class="border p-3 text-left">Created</th>
                        <th class="border p-3 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for flow in flows %}
                    <tr class="hover:bg-gray-50">
                        <td class="border p-3">
                            <div>
                                <strong>{{ flow.name }}</strong>
                                {% if flow.description %}
                                <p class="text-sm text-gray-600 mt-1">{{ flow.description }}</p>
                                {% endif %}
                            </div>
                        </td>
                        <td class="border p-3">{{ flow.group.name }}</td>
                        <td class="border p-3">
                            <span class="px-2 py-1 rounded-full text-xs {{ 'bg-green-100 text-green-800' if flow.is_active else 'bg-gray-100 text-gray-800' }}">
                                {{ 'Active' if flow.is_active else 'Inactive' }}
                            </span>
                        </td>
                        <td class="border p-3">
                            <span class="text-sm text-gray-600">{{ flow.states|length }} states</span>
                        </td>
                        <td class="border p-3">
                            {{ flow.created_at.strftime('%Y-%m-%d') }}
                        </td>
                        <td class="border p-3">
                            <div class="flex space-x-2">
                                <a href="/admin/flows/{{ flow.id }}/edit" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </a>
                                {% if not flow.is_active %}
                                <button onclick="activateFlow({{ flow.id }})" class="text-green-600 hover:text-green-800 text-sm">
                                    <i class="fas fa-play mr-1"></i>Activate
                                </button>
                                {% else %}
                                <button onclick="deactivateFlow({{ flow.id }})" class="text-yellow-600 hover:text-yellow-800 text-sm">
                                    <i class="fas fa-pause mr-1"></i>Deactivate
                                </button>
                                {% endif %}
                                <button onclick="deleteFlow({{ flow.id }}, '{{ flow.name }}')" class="text-red-600 hover:text-red-800 text-sm">
                                    <i class="fas fa-trash mr-1"></i>Delete
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8">
            <div class="mb-4">
                <i class="fas fa-sitemap text-4xl text-gray-300"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No flows found</h3>
            <p class="text-gray-500 mb-4">Get started by creating your first conversation flow.</p>
            <button onclick="showCreateFlowModal()" class="btn btn-primary">
                <i class="fas fa-plus mr-2"></i>Create New Flow
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Create Flow Modal -->
    <div id="createFlowModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Create New Flow</h3>
                <form hx-post="/admin/flows/create" hx-target="#createFlowModal" hx-swap="outerHTML">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Flow Name</label>
                        <input type="text" name="name" required class="form-input w-full" placeholder="Enter flow name">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Group</label>
                        <select name="group_id" required class="form-select w-full">
                            <option value="">Select a group</option>
                            {% for group in groups %}
                            <option value="{{ group.id }}">{{ group.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                        <textarea name="description" class="form-textarea w-full" rows="3" placeholder="Describe this flow..."></textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="hideCreateFlowModal()" class="btn btn-outline">Cancel</button>
                        <button type="submit" class="btn btn-primary">Create Flow</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
function showCreateFlowModal() {
    document.getElementById('createFlowModal').classList.remove('hidden');
}

function hideCreateFlowModal() {
    document.getElementById('createFlowModal').classList.add('hidden');
}

function filterFlows() {
    const groupId = document.getElementById('groupFilter').value;
    const url = groupId ? `/admin/flows?group_id=${groupId}` : '/admin/flows';
    window.location.href = url;
}

function activateFlow(flowId) {
    if (confirm('Are you sure you want to activate this flow? This will deactivate any currently active flow for this group.')) {
        fetch(`/admin/flows/${flowId}/activate`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to activate flow'));
                }
            })
            .catch(error => {
                alert('Error activating flow');
                console.error(error);
            });
    }
}

function deactivateFlow(flowId) {
    if (confirm('Are you sure you want to deactivate this flow?')) {
        fetch(`/admin/flows/${flowId}/deactivate`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to deactivate flow'));
                }
            })
            .catch(error => {
                alert('Error deactivating flow');
                console.error(error);
            });
    }
}

function deleteFlow(flowId, flowName) {
    if (confirm(`Are you sure you want to delete the flow "${flowName}"? This action cannot be undone.`)) {
        fetch(`/admin/flows/${flowId}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete flow'));
                }
            })
            .catch(error => {
                alert('Error deleting flow');
                console.error(error);
            });
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('createFlowModal');
    if (event.target === modal) {
        hideCreateFlowModal();
    }
}
</script>
{% endblock %}