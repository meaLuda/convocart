{% extends "base.html" %}

{% block title %}Cart Recovery Settings | ConvoCart{% endblock %}

{% block page_title %}Cart Recovery Settings{% endblock %}

{% block content %}
{% if success_message %}
<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-6 animate-fade-in">
    <div class="flex items-center">
        <i class="fas fa-check-circle mr-2"></i>
        <span>{{ success_message }}</span>
    </div>
</div>
{% endif %}

<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Cart Recovery Configuration</h1>
        
        <div class="flex space-x-2">
            <a href="/admin/cart-recovery/analytics" class="btn btn-outline">
                <i class="fas fa-chart-bar mr-2"></i>
                Analytics
            </a>
            <a href="/admin/cart-recovery/abandoned-carts" class="btn btn-outline">
                <i class="fas fa-shopping-cart mr-2"></i>
                Abandoned Carts
            </a>
        </div>
    </div>
    
    <!-- Success message area -->
    <div id="success-message-area"></div>
    
    <form 
        hx-post="/admin/cart-recovery/configuration"
        hx-target="#success-message-area"
        hx-swap="innerHTML"
        hx-indicator="#loading-indicator"
        id="config-form"
        class="space-y-6">
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Abandonment Detection Settings -->
            <div class="card">
                <div class="p-4">
                    <h3 class="text-lg font-medium mb-4">Abandonment Detection</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="abandonment_threshold" class="block text-sm font-medium text-gray-700 mb-1">
                                Abandonment Threshold (minutes)
                            </label>
                            <input 
                                type="number" 
                                id="abandonment_threshold"
                                name="abandonment_threshold"
                                value="{{ configs.cart_abandonment_threshold_minutes }}"
                                min="1"
                                max="60"
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <p class="text-xs text-gray-500 mt-1">
                                Time before a cart is considered abandoned
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recovery Campaign Settings -->
            <div class="card">
                <div class="p-4">
                    <h3 class="text-lg font-medium mb-4">Recovery Campaigns</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="max_attempts" class="block text-sm font-medium text-gray-700 mb-1">
                                Maximum Recovery Attempts
                            </label>
                            <input 
                                type="number" 
                                id="max_attempts"
                                name="max_attempts"
                                value="{{ configs.cart_recovery_max_attempts }}"
                                min="1"
                                max="10"
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <p class="text-xs text-gray-500 mt-1">
                                Maximum number of recovery messages per cart
                            </p>
                        </div>
                        
                        <div>
                            <label for="recovery_interval" class="block text-sm font-medium text-gray-700 mb-1">
                                Recovery Interval (hours)
                            </label>
                            <input 
                                type="number" 
                                id="recovery_interval"
                                name="recovery_interval"
                                value="{{ configs.cart_recovery_interval_hours }}"
                                min="1"
                                max="72"
                                class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500">
                            <p class="text-xs text-gray-500 mt-1">
                                Time between recovery attempts
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Incentive Settings -->
            <div class="card">
                <div class="p-4">
                    <h3 class="text-lg font-medium mb-4">Incentives & Discounts</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="flex items-center">
                                <input 
                                    type="checkbox" 
                                    name="discount_enabled"
                                    {{ 'checked' if configs.recovery_discount_enabled == 'true' else '' }}
                                    class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                <span class="ml-2 text-sm font-medium text-gray-700">
                                    Enable Recovery Discounts
                                </span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1 ml-6">
                                Offer discounts to encourage cart completion
                            </p>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                            <div class="flex items-start">
                                <i class="fas fa-lightbulb text-yellow-600 mt-0.5 mr-2"></i>
                                <div class="text-sm text-yellow-800">
                                    <p class="font-medium">AI-Powered Personalization</p>
                                    <p>The system uses AI to determine the best recovery message and incentive for each customer based on their behavior and preferences.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analytics Settings -->
            <div class="card">
                <div class="p-4">
                    <h3 class="text-lg font-medium mb-4">Analytics & Reporting</h3>
                    
                    <div class="space-y-4">
                        <div class="bg-gray-50 border border-gray-200 rounded p-3">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <div class="font-medium text-gray-700">Current Settings</div>
                                    <div class="text-gray-600">Threshold: {{ configs.cart_abandonment_threshold_minutes }}min</div>
                                    <div class="text-gray-600">Max attempts: {{ configs.cart_recovery_max_attempts }}</div>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-700">Status</div>
                                    <div class="text-gray-600">Interval: {{ configs.cart_recovery_interval_hours }}h</div>
                                    <div class="text-gray-600">Discounts: {{ 'Enabled' if configs.recovery_discount_enabled == 'true' else 'Disabled' }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-sm text-gray-600">
                            <p>Analytics are automatically generated and updated hourly. View detailed reports in the Analytics section.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Save Button -->
        <div class="flex justify-end space-x-3 pt-6 border-t">
            <button type="button" onclick="resetForm()" class="btn btn-outline">
                Reset
            </button>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save mr-2"></i>
                Save Configuration
                <span id="loading-indicator" class="htmx-indicator ml-2">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
            </button>
        </div>
    </form>
</div>

<!-- Success/Error Messages -->
<div id="flash-messages" class="fixed top-4 right-4 z-50"></div>

<script>
function resetForm() {
    document.getElementById('config-form').reset();
    location.reload();
}

// Add fade-in animation
const style = document.createElement('style');
style.textContent = `
    .animate-fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
`;
document.head.appendChild(style);

// Auto-hide success message after 5 seconds
document.addEventListener('DOMContentLoaded', function() {
    const successMessage = document.querySelector('.bg-green-100');
    if (successMessage) {
        setTimeout(() => {
            successMessage.style.opacity = '0';
            setTimeout(() => {
                successMessage.remove();
            }, 300);
        }, 5000);
    }
});
</script>
{% endblock %}