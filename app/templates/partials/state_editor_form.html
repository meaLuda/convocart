<!-- Enhanced State Editor Form -->
<form hx-post="/admin/flows/states/{{ state.id if state else temp_id }}/save" hx-swap="none">
    <div class="space-y-3">
        <!-- Row 1: Name and Type -->
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">State Name *</label>
                <input type="text" name="name" value="{{ state.name if state else 'New State' }}" 
                       required class="w-full px-2 py-1 border border-gray-200 rounded focus:border-blue-500 focus:ring-0 text-sm" 
                       placeholder="State name">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-700 mb-1">Type</label>
                <select name="state_type" class="w-full px-2 py-1 border border-gray-200 rounded focus:border-blue-500 focus:ring-0 bg-white text-sm">
                    {% for value, label in state_types %}
                    <option value="{{ value }}" {{ 'selected' if state and state.state_type.value == value else '' }}>
                        {{ label }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <!-- Row 2: Start State Checkbox -->
        <div class="bg-green-50 border border-green-200 rounded p-2">
            <label class="flex items-center cursor-pointer">
                <input type="checkbox" name="is_start_state" id="isStartState" 
                       {{ 'checked' if state and state.is_start_state else '' }} 
                       class="rounded border-green-300 text-green-600 focus:ring-green-500">
                <span class="ml-2 text-xs text-green-800">Start State (first state in conversation)</span>
            </label>
        </div>
        
        <!-- Row 3: Message Body -->
        <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Message Body</label>
            <textarea name="message_body" 
                      class="w-full px-2 py-1 border border-gray-200 rounded focus:border-blue-500 focus:ring-0 resize-none text-sm" 
                      rows="2" 
                      placeholder="Message to send when this state is active...">{{ state.message_body if state else '' }}</textarea>
        </div>
        
        <!-- Row 4: Buttons -->
        <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">Quick Reply Buttons (JSON)</label>
            <textarea name="buttons_config" 
                      class="w-full px-2 py-1 bg-gray-50 border border-gray-200 rounded focus:border-blue-500 focus:ring-0 font-mono text-xs" 
                      rows="2" 
                      placeholder='[{"id": "yes", "title": "Yes"}, {"id": "no", "title": "No"}]'>{% if state and state.state_config and state.state_config.buttons %}{{ state.state_config.buttons | tojson }}{% endif %}</textarea>
        </div>
    </div>
    
    <!-- Transitions -->
    <div class="mt-3">
        <div class="flex justify-between items-center mb-2">
            <span class="text-xs font-medium text-gray-700">Transitions</span>
            <button type="button" onclick="addTransition()" class="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs hover:bg-gray-200">
                <i class="fas fa-plus mr-1"></i>Add
            </button>
        </div>
        
        <div id="transitionsContainer">
            {% if state and state.outgoing_transitions %}
                {% for transition in state.outgoing_transitions %}
                <div class="transition-row border rounded p-3 mb-3 bg-gray-50">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Trigger Type</label>
                            <select name="transitions[{{ loop.index0 }}][trigger_type]" class="form-select w-full text-sm">
                                {% for tt_value, tt_label in trigger_types %}
                                <option value="{{ tt_value }}" {{ 'selected' if transition.trigger_type.value == tt_value else '' }}>
                                    {{ tt_label }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Trigger Value</label>
                            <input type="text" name="transitions[{{ loop.index0 }}][trigger_value]" 
                                   value="{{ transition.trigger_value or '' }}" 
                                   class="form-input w-full text-sm" placeholder="e.g., 'yes' or 'button_id'">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-1">Action</label>
                            <select name="transitions[{{ loop.index0 }}][action_id]" class="form-select w-full text-sm">
                                <option value="">No Action</option>
                                {% for action in actions %}
                                <option value="{{ action.id }}" {{ 'selected' if transition.action_id == action.id else '' }}>
                                    {{ action.display_name }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button type="button" onclick="removeTransition(this)" 
                                    class="btn btn-outline btn-sm text-red-600 hover:bg-red-50">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="transitions[{{ loop.index0 }}][id]" value="{{ transition.id }}">
                    <input type="hidden" name="transitions[{{ loop.index0 }}][target_state_id]" value="{{ transition.target_state_id }}">
                </div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
    
    <!-- Form Actions -->
    <div class="mt-3 pt-3 border-t border-gray-200 flex justify-end gap-2">
        <button type="button" onclick="hideStateEditor()" 
                class="px-3 py-1 border border-gray-300 text-gray-700 rounded hover:bg-gray-50 text-xs">
            Cancel
        </button>
        <button type="submit" 
                class="px-4 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-xs">
            {{ 'Create' if is_new else 'Save' }}
        </button>
    </div>
</form>

<!-- Enhanced JavaScript for form interactions -->
<script>
let transitionCounter = {{ state.outgoing_transitions|length if state and state.outgoing_transitions else 0 }};

// Enhanced checkbox styling
document.addEventListener('DOMContentLoaded', function() {
    const checkbox = document.getElementById('isStartState');
    const checkboxCustom = document.querySelector('.checkbox-custom');
    const checkIcon = checkboxCustom?.querySelector('i');
    
    if (checkbox && checkboxCustom && checkIcon) {
        function updateCheckbox() {
            if (checkbox.checked) {
                checkboxCustom.style.background = '#10b981';
                checkboxCustom.style.borderColor = '#10b981';
                checkIcon.style.opacity = '1';
            } else {
                checkboxCustom.style.background = 'white';
                checkboxCustom.style.borderColor = '#d1fae5';
                checkIcon.style.opacity = '0';
            }
        }
        
        checkbox.addEventListener('change', updateCheckbox);
        updateCheckbox(); // Initial state
        
        // Click handler for custom checkbox
        checkboxCustom.addEventListener('click', function() {
            checkbox.checked = !checkbox.checked;
            updateCheckbox();
        });
    }
    
    // Auto-resize textareas
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });
    });
    
    // JSON validation for buttons config
    const buttonsConfig = document.querySelector('textarea[name="buttons_config"]');
    if (buttonsConfig) {
        buttonsConfig.addEventListener('blur', function() {
            const value = this.value.trim();
            if (value) {
                try {
                    JSON.parse(value);
                    this.style.borderColor = '#10b981';
                    this.style.background = '#f0fdf4';
                } catch (e) {
                    this.style.borderColor = '#ef4444';
                    this.style.background = '#fef2f2';
                }
            } else {
                this.style.borderColor = '#d1d5db';
                this.style.background = 'white';
            }
        });
    }
});

function addTransition() {
    const container = document.getElementById('transitionsContainer');
    const transitionHtml = `
        <div class="transition-row border-2 border-gray-200 rounded-lg p-4 mb-4 bg-gradient-to-r from-gray-50 to-white hover:shadow-md transition-all duration-200">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Trigger Type</label>
                    <select name="transitions[${transitionCounter}][trigger_type]" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500">
                        {% for tt_value, tt_label in trigger_types %}
                        <option value="{{ tt_value }}">{{ tt_label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Trigger Value</label>
                    <input type="text" name="transitions[${transitionCounter}][trigger_value]" 
                           class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500" 
                           placeholder="e.g., 'yes' or 'button_id'">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Action</label>
                    <select name="transitions[${transitionCounter}][action_id]" class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg focus:border-blue-500">
                        <option value="">No Action</option>
                        {% for action in actions %}
                        <option value="{{ action.id }}">{{ action.display_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="button" onclick="removeTransition(this)" 
                            class="px-4 py-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-500 hover:text-white transition-all duration-200 flex items-center gap-2">
                        <i class="fas fa-trash"></i>
                        Remove
                    </button>
                </div>
            </div>
            <input type="hidden" name="transitions[${transitionCounter}][target_state_id]" value="">
        </div>
    `;
    container.insertAdjacentHTML('beforeend', transitionHtml);
    transitionCounter++;
}

function removeTransition(button) {
    const row = button.closest('.transition-row');
    row.style.transform = 'scale(0.95)';
    row.style.opacity = '0.5';
    setTimeout(() => row.remove(), 200);
}
</script>