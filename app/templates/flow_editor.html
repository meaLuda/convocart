{% extends "admin_base.html" %}

{% block title %}Flow Editor - {{ flow.name }} | WhatsApp Order Bot{% endblock %}

{% block page_title %}Flow Editor{% endblock %}

{% block content %}
<!-- Fixed Layout: Canvas Left, Sidebar Right -->
<div class="flex gap-6 h-[calc(100vh-200px)]">

    <!-- Main Canvas (Left Side) -->
    <div class="flex-1 min-w-0">
        <div class="modern-card p-6 h-full" data-aos="fade-right">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i class="fas fa-project-diagram text-purple-500"></i>
                        Flow Canvas
                    </h3>
                    <p class="text-sm text-gray-500 mt-1">Drag states to reposition â€¢ Click handles to connect</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="autoLayout()" class="btn btn-outline btn-sm flex items-center gap-2">
                        <i class="fas fa-magic"></i>Auto Layout
                    </button>
                    <button onclick="fitToScreen()" class="btn btn-outline btn-sm flex items-center gap-2">
                        <i class="fas fa-expand-arrows-alt"></i>Fit Screen
                    </button>
                    <div class="flex border border-gray-200 rounded-lg overflow-hidden">
                        <button onclick="zoomOut()" class="px-3 py-2 hover:bg-gray-50 border-r" title="Zoom Out">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <span id="zoomLevel"
                            class="px-3 py-2 text-sm font-medium bg-gray-50 min-w-16 text-center">100%</span>
                        <button onclick="zoomIn()" class="px-3 py-2 hover:bg-gray-50 border-l" title="Zoom In">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </div>
                    <button onclick="showKeyboardShortcuts()" class="btn btn-outline btn-sm flex items-center gap-2"
                        title="Keyboard Shortcuts">
                        <i class="fas fa-keyboard"></i>Shortcuts
                    </button>
                </div>
            </div>

            <div class="relative h-[calc(100%-80px)]">
                <!-- Enhanced Flow Canvas -->
                <div id="flowCanvas" class="flow-canvas border border-gray-200 relative h-full"
                    style="transform-origin: top left; transform: scale(1);">
                    <!-- Canvas Tools Overlay -->
                    <div class="zoom-controls">
                        <button onclick="centerView()" class="zoom-btn" title="Center View">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                    </div>

                    <!-- States will be rendered here -->
                    {% for state in flow.states %}
                    <div class="state-node {{ 'start-state' if state.is_start_state else '' }}"
                        id="state-{{ state.id }}" data-state-id="{{ state.id }}" data-aos="zoom-in"
                        data-aos-delay="{{ loop.index0 * 100 }}"
                        style="left: {{ loop.index0 * 280 + 50 }}px; top: {{ (loop.index0 % 3) * 180 + 50 }}px;">

                        <div class="state-header">
                            <h4 class="state-title">{{ state.name }}</h4>
                            <div class="state-actions">
                                <button onclick="editState({{ state.id }})" class="state-btn edit-btn"
                                    title="Edit State">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="duplicateState({{ state.id }})" class="state-btn"
                                    style="background: #fef3c7; color: #d97706;" title="Duplicate">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button onclick="deleteState({{ state.id }})" class="state-btn delete-btn"
                                    title="Delete State">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="state-content">
                            {% if state.message_body %}
                            <div class="state-message">
                                {{ state.message_body[:60] }}{% if state.message_body|length > 60 %}...{% endif %}
                            </div>
                            {% endif %}
                            <div class="flex justify-between items-center">
                                <span class="state-type">{{ state.state_type.value|replace('_', ' ') }}</span>
                                <span class="text-xs text-gray-400">{{ state.outgoing_transitions|length }}
                                    transitions</span>
                            </div>
                        </div>

                        <!-- Enhanced Connection Handles -->
                        <div class="connection-handle right-handle" data-state-id="{{ state.id }}"
                            title="Connect to other states"></div>
                        <div class="connection-handle left-handle" title="Input connection"></div>
                    </div>
                    {% endfor %}

                    <!-- Connection lines will be drawn here by JavaScript -->
                    <svg id="connectionSvg" class="absolute inset-0 pointer-events-none" style="z-index: 1;">
                        <!-- SVG connections will be drawn here -->
                    </svg>
                </div>

                <!-- Minimap -->
                <div class="minimap">
                    <div class="p-2 bg-gray-50 text-xs font-medium border-b">Canvas Overview</div>
                    <div id="minimapContent" class="relative h-full bg-white"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar (Right Side) -->
    <div class="w-80 flex-shrink-0 space-y-4 overflow-y-auto custom-scrollbar">
        <!-- Flow Info -->
        <div class="modern-card p-4" data-aos="fade-left">
            <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                <i class="fas fa-info-circle text-blue-500"></i>
                Flow Information
            </h3>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
                    <input type="text" id="flowName" value="{{ flow.name }}" class="form-input w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="flowDescription" class="form-textarea w-full"
                        rows="2">{{ flow.description or '' }}</textarea>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="flowActive" {{ 'checked' if flow.is_active else '' }}
                        class="form-checkbox">
                    <label for="flowActive" class="ml-2 text-sm text-gray-700">Active</label>
                </div>
            </div>
        </div>

        <!-- Enhanced Add State -->
        <div class="modern-card p-4" data-aos="fade-left" data-aos-delay="100">
            <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                <i class="fas fa-plus-circle text-blue-500"></i>
                Add Components
            </h3>
            <div class="space-y-2">
                <button onclick="addState()"
                    class="btn-modern w-full text-sm py-2 flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i>
                    <span>Message State</span>
                </button>
                <button onclick="addDecisionState()"
                    class="btn-secondary w-full text-sm py-2 flex items-center justify-center gap-2">
                    <i class="fas fa-code-branch"></i>
                    <span>Decision State</span>
                </button>
                <button onclick="toggleActionLibrary()"
                    class="btn-success w-full text-sm py-2 flex items-center justify-center gap-2">
                    <i class="fas fa-cogs"></i>
                    <span>Action Library</span>
                </button>
            </div>
        </div>

        <!-- Enhanced Action Library -->
        <div id="actionLibrary" class="modern-card p-4 hidden" data-aos="fade-left" data-aos-delay="200">
            <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                <i class="fas fa-puzzle-piece text-green-500"></i>
                Action Library
            </h3>
            <div class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                {% if actions %}
                {% for action in actions %}
                <div class="action-item" onclick="selectAction({{ action.id }}, '{{ action.display_name }}')">
                    <div class="flex items-center gap-2">
                        <div
                            class="w-6 h-6 bg-gradient-to-br from-blue-500 to-purple-600 rounded flex items-center justify-center text-white text-xs font-bold">
                            {{ action.display_name[0:1]|upper }}
                        </div>
                        <div class="flex-1">
                            <div class="font-medium text-xs text-gray-900">{{ action.display_name }}</div>
                            <div class="text-xs text-gray-500">{{ (action.description[:25] + '...') if
                                action.description and action.description|length > 25 else action.description or 'No
                                description' }}</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-6">
                    <i class="fas fa-puzzle-piece text-gray-400 text-2xl mb-2"></i>
                    <p class="text-sm text-gray-500">No actions available</p>
                    <p class="text-xs text-gray-400">Contact admin to add flow actions</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Enhanced State Editor Modal -->
<div id="stateEditorModal"
    class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="bg-white rounded-2xl shadow-2xl border-0 overflow-hidden flex flex-col max-h-full"
            data-aos="zoom-in" data-aos-duration="300">
            <!-- Compact Modal Header -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-4 py-2 flex-shrink-0">
                <div class="flex justify-between items-center">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-edit text-white text-sm"></i>
                        <h3 class="text-sm font-medium text-white">Edit State</h3>
                    </div>
                    <button onclick="hideStateEditor()"
                        class="w-6 h-6 bg-white bg-opacity-20 hover:bg-opacity-30 rounded flex items-center justify-center text-white">
                        <i class="fas fa-times text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="p-4 overflow-y-auto custom-scrollbar flex-1 min-h-0">
                <div id="stateEditorContent">
                    <!-- Content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Transition Editor Modal -->
<div id="transitionEditorModal"
    class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 backdrop-blur-sm flex items-center justify-center p-4">
    <div class="w-full max-w-4xl max-h-[90vh] flex flex-col">
        <div class="bg-white rounded-2xl shadow-2xl border-0 overflow-hidden flex flex-col max-h-full"
            data-aos="zoom-in" data-aos-duration="300">
            <!-- Modal Header -->
            <div class="bg-gradient-to-r from-green-600 to-teal-600 px-6 py-4 flex-shrink-0"></div>
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
                        <i class="fas fa-arrow-right text-white text-sm"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-white">Transition Editor</h3>
                        <p class="text-green-100 text-sm">Define how states connect and transition</p>
                    </div>
                </div>
                <button onclick="hideTransitionEditor()"
                    class="w-8 h-8 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg flex items-center justify-center text-white transition-all duration-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <!-- Modal Content -->
        <div class="p-6 overflow-y-auto custom-scrollbar flex-1 min-h-0"></div>
        <div id="transitionEditorContent">
            <!-- Content will be loaded here -->
        </div>
    </div>
</div>
</div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Enhanced Flow Editor State
    let selectedState = null;
    let connectionMode = false;
    let sourceStateId = null;
    let currentZoom = 1;
    let isPanning = false;
    let lastPanPoint = { x: 0, y: 0 };
    let stateCounter = 1;

    // Initialize AOS animations and HTMX
    document.addEventListener('DOMContentLoaded', function () {
        AOS.init({
            duration: 600,
            easing: 'ease-out-cubic',
            once: false,
            mirror: true
        });

        initializeCanvas();
        setupEventListeners();
        updateMinimap();

        // Debug HTMX
        console.log('HTMX available:', typeof htmx !== 'undefined');

        // HTMX event handlers
        document.body.addEventListener('htmx:afterRequest', function (evt) {
            if (evt.detail.xhr.status === 200) {
                try {
                    const response = JSON.parse(evt.detail.xhr.response);
                    if (response.success) {
                        if (response.action === 'close_modal') {
                            hideStateEditor();
                        }
                        showNotification(response.message || 'Saved successfully', 'success');

                        // Update state node if editing
                        if (window.currentEditingStateId) {
                            const stateNode = document.getElementById(`state-${window.currentEditingStateId}`);
                            if (stateNode) {
                                // Refresh the page to show updated states
                                location.reload();
                            }
                        }
                    } else {
                        showNotification(response.error || 'Save failed', 'error');
                    }
                } catch (e) {
                    console.log('Response was not JSON, might be HTML');
                }
            } else {
                showNotification('Error saving', 'error');
            }
        });
    });

    // Initialize canvas with enhanced features
    function initializeCanvas() {
        const canvas = document.getElementById('flowCanvas');
        makeCanvasDraggable(canvas);
        setupConnectionHandlers();
        drawExistingConnections();
    }

    // Enhanced state creation with better UX
    function addState() {
        const canvas = document.getElementById('flowCanvas');
        const newStateId = 'temp-' + Date.now();

        // Find a good position for the new state
        const position = findOptimalStatePosition();

        const stateDiv = document.createElement('div');
        stateDiv.className = 'state-node';
        stateDiv.id = `state-${newStateId}`;
        stateDiv.style.left = position.x + 'px';
        stateDiv.style.top = position.y + 'px';
        stateDiv.setAttribute('data-state-id', newStateId);

        stateDiv.innerHTML = `
        <div class="state-header">
            <h4 class="state-title">New State ${stateCounter++}</h4>
            <div class="state-actions">
                <button onclick="editState('${newStateId}')" class="state-btn edit-btn" title="Edit State">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="duplicateState('${newStateId}')" class="state-btn" style="background: #fef3c7; color: #d97706;" title="Duplicate">
                    <i class="fas fa-copy"></i>
                </button>
                <button onclick="deleteState('${newStateId}')" class="state-btn delete-btn" title="Delete State">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="state-content">
            <div class="state-message">Click edit to configure this state...</div>
            <div class="flex justify-between items-center">
                <span class="state-type">Send Message</span>
                <span class="text-xs text-gray-400">0 transitions</span>
            </div>
        </div>
        <div class="connection-handle right-handle" data-state-id="${newStateId}" title="Connect to other states"></div>
        <div class="connection-handle left-handle" title="Input connection"></div>
    `;

        // Add with animation
        canvas.appendChild(stateDiv);

        // Animate in
        stateDiv.style.transform = 'scale(0.8) rotate(5deg)';
        stateDiv.style.opacity = '0';

        setTimeout(() => {
            stateDiv.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
            stateDiv.style.transform = 'scale(1) rotate(0deg)';
            stateDiv.style.opacity = '1';
        }, 10);

        // Make draggable and select
        makeStateDraggable(stateDiv);
        selectState(stateDiv);

        // Auto-open editor
        setTimeout(() => editState(newStateId), 500);

        updateMinimap();
    }

    // Enhanced state editing with loading states and proper HTMX
    function editState(stateId) {
        window.currentEditingStateId = stateId;

        const modal = document.getElementById('stateEditorModal');
        const content = document.getElementById('stateEditorContent');

        // Show loading state
        if (content) {
            content.innerHTML = `
            <div class="flex items-center justify-center py-12">
                <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                <span class="ml-3 text-gray-600">Loading state editor...</span>
            </div>
        `;
        }

        modal.classList.remove('hidden');
        modal.style.opacity = '0';
        modal.style.transition = 'opacity 0.3s ease';

        setTimeout(() => {
            modal.style.opacity = '1';
        }, 10);

        // Use HTMX if available, fallback to fetch
        if (typeof htmx !== 'undefined') {
            htmx.ajax('GET', `/admin/flows/states/${stateId}/edit`, {
                target: '#stateEditorContent',
                swap: 'innerHTML'
            });
        } else {
            // Fallback to fetch
            fetch(`/admin/flows/states/${stateId}/edit`)
                .then(response => response.text())
                .then(html => {
                    if (content) {
                        content.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error loading state editor:', error);
                    if (content) {
                        content.innerHTML = '<p class="text-red-500">Error loading state editor. Please try again.</p>';
                    }
                });
        }

        // Highlight the state being edited
        selectStateById(stateId);
    }

    // Add decision state with different styling and pre-configured options
    function addDecisionState() {
        const canvas = document.getElementById('flowCanvas');
        const newStateId = 'temp-' + Date.now();

        // Find a good position for the new state
        const position = findOptimalStatePosition();

        const stateDiv = document.createElement('div');
        stateDiv.className = 'state-node decision-state';
        stateDiv.id = `state-${newStateId}`;
        stateDiv.style.left = position.x + 'px';
        stateDiv.style.top = position.y + 'px';
        stateDiv.setAttribute('data-state-id', newStateId);

        stateDiv.innerHTML = `
        <div class="state-header">
            <h4 class="state-title">Decision Point ${stateCounter++}</h4>
            <div class="state-actions">
                <button onclick="editState('${newStateId}')" class="state-btn edit-btn" title="Edit State">
                    <i class="fas fa-edit"></i>
                </button>
                <button onclick="duplicateState('${newStateId}')" class="state-btn" style="background: #fef3c7; color: #d97706;" title="Duplicate">
                    <i class="fas fa-copy"></i>
                </button>
                <button onclick="deleteState('${newStateId}')" class="state-btn delete-btn" title="Delete State">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="state-content">
            <div class="state-message">Choose an option to continue...</div>
            <div class="flex justify-between items-center">
                <span class="state-type">Decision Point</span>
                <span class="text-xs text-gray-400">0 transitions</span>
            </div>
        </div>
        <div class="connection-handle right-handle" data-state-id="${newStateId}" title="Connect to other states"></div>
        <div class="connection-handle left-handle" title="Input connection"></div>
    `;

        // Add with animation
        canvas.appendChild(stateDiv);

        // Animate in
        stateDiv.style.transform = 'scale(0.8) rotate(5deg)';
        stateDiv.style.opacity = '0';

        setTimeout(() => {
            stateDiv.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
            stateDiv.style.transform = 'scale(1) rotate(0deg)';
            stateDiv.style.opacity = '1';
        }, 10);

        // Make draggable and select
        makeStateDraggable(stateDiv);
        selectState(stateDiv);

        // Store default decision state configuration
        if (!window.pendingStateChanges) {
            window.pendingStateChanges = {};
        }
        window.pendingStateChanges[newStateId] = {
            name: `Decision Point ${stateCounter - 1}`,
            message_body: 'Please choose one of the options below:',
            state_type: 'SEND_MESSAGE',
            is_start_state: false,
            buttons_config: '[{"id": "option_1", "title": "Option 1"}, {"id": "option_2", "title": "Option 2"}]'
        };

        // Auto-open editor with decision state defaults
        setTimeout(() => editState(newStateId), 500);

        updateMinimap();
        showNotification('Decision state created with default options', 'success');
    }

    // Find optimal position for new states
    function findOptimalStatePosition() {
        const canvas = document.getElementById('flowCanvas');
        const existingStates = canvas.querySelectorAll('.state-node');

        let x = 100;
        let y = 100;
        const spacing = 280;

        // Simple grid placement
        const col = existingStates.length % 3;
        const row = Math.floor(existingStates.length / 3);

        x = col * spacing + 50;
        y = row * 180 + 50;

        return { x, y };
    }

    // Enhanced state deletion with animation
    function deleteState(stateId) {
        const stateNode = document.getElementById(`state-${stateId}`);
        if (!stateNode) return;

        // Custom confirmation with better UX
        if (confirm(`Delete "${stateNode.querySelector('.state-title').textContent}"?\n\nThis action cannot be undone.`)) {
            // Animate out
            stateNode.style.transition = 'all 0.4s ease-in';
            stateNode.style.transform = 'scale(0.8) rotate(-5deg)';
            stateNode.style.opacity = '0';

            setTimeout(() => {
                stateNode.remove();
                updateMinimap();
                showNotification('State deleted successfully', 'info');
            }, 400);
        }
    }

    // Duplicate state functionality
    function duplicateState(stateId) {
        const originalState = document.getElementById(`state-${stateId}`);
        if (!originalState) return;

        const newStateId = 'temp-' + Date.now();

        const clone = originalState.cloneNode(true);
        clone.id = `state-${newStateId}`;
        clone.setAttribute('data-state-id', newStateId);

        // Offset position
        const currentLeft = parseInt(originalState.style.left) || 0;
        const currentTop = parseInt(originalState.style.top) || 0;
        clone.style.left = (currentLeft + 30) + 'px';
        clone.style.top = (currentTop + 30) + 'px';

        // Update title
        const title = clone.querySelector('.state-title');
        title.textContent = title.textContent + ' (Copy)';

        // Update button handlers
        clone.querySelector('.edit-btn').setAttribute('onclick', `editState('${newStateId}')`);
        clone.querySelector('.delete-btn').setAttribute('onclick', `deleteState('${newStateId}')`);

        const canvas = document.getElementById('flowCanvas');
        canvas.appendChild(clone);
        makeStateDraggable(clone);

        // Animate in
        clone.style.transform = 'scale(0.9)';
        clone.style.opacity = '0.7';

        setTimeout(() => {
            clone.style.transition = 'all 0.3s ease';
            clone.style.transform = 'scale(1)';
            clone.style.opacity = '1';
        }, 10);

        showNotification('State duplicated', 'success');
        updateMinimap();
    }

    // Form submission is now handled by HTMX

    // Update state node visual representation
    function updateStateNodeDisplay(stateNode, formData) {
        const title = stateNode.querySelector('.state-title');
        const message = stateNode.querySelector('.state-message');
        const type = stateNode.querySelector('.state-type');

        if (title) title.textContent = formData.get('name') || 'Unnamed State';
        if (message) {
            const messageBody = formData.get('message_body');
            message.textContent = messageBody ?
                (messageBody.length > 60 ? messageBody.substring(0, 60) + '...' : messageBody) :
                'No message configured';
        }
        if (type) {
            const stateType = formData.get('state_type') || 'SEND_MESSAGE';
            type.textContent = stateType.replace('_', ' ');
        }

        // Add start state styling if needed
        if (formData.get('is_start_state')) {
            stateNode.classList.add('start-state');
        } else {
            stateNode.classList.remove('start-state');
        }
    }

    // Enhanced modal hiding with animation
    function hideStateEditor() {
        const modal = document.getElementById('stateEditorModal');
        modal.style.opacity = '0';

        setTimeout(() => {
            modal.classList.add('hidden');
            modal.style.opacity = '1'; // Reset for next time
        }, 300);

        // Clear selection
        clearStateSelection();
    }

    // Enhanced action library toggle with animation and feedback
    function toggleActionLibrary() {
        const library = document.getElementById('actionLibrary');
        const button = event.target.closest('button');
        const isHidden = library.classList.contains('hidden');

        // Add click feedback
        if (button) {
            button.style.transform = 'scale(0.95)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 150);
        }

        if (isHidden) {
            library.classList.remove('hidden');
            library.style.opacity = '0';
            library.style.transform = 'translateY(-10px)';

            setTimeout(() => {
                library.style.transition = 'all 0.3s ease';
                library.style.opacity = '1';
                library.style.transform = 'translateY(0)';
            }, 10);

            showNotification('Action Library opened', 'info');
        } else {
            library.style.opacity = '0';
            library.style.transform = 'translateY(-10px)';

            setTimeout(() => {
                library.classList.add('hidden');
                library.style.opacity = '1';
                library.style.transform = 'translateY(0)';
            }, 300);

            showNotification('Action Library closed', 'info');
        }
    }

    // Enhanced action selection with visual feedback and state creation
    function selectAction(actionId, actionName) {
        // Visual feedback
        const actionItem = event.currentTarget;

        // Remove previous selections
        document.querySelectorAll('.action-item').forEach(item => {
            item.classList.remove('selected-action');
        });

        // Mark this item as selected
        actionItem.classList.add('selected-action');
        actionItem.style.transform = 'scale(0.95)';
        actionItem.style.background = '#dbeafe';
        actionItem.style.borderColor = '#3b82f6';

        setTimeout(() => {
            actionItem.style.transform = 'scale(1)';
        }, 150);

        // Store selected action for future use
        window.selectedAction = { id: actionId, name: actionName };

        // Provide options to user
        showActionOptions(actionId, actionName);
    }

    // Show options for what to do with selected action
    function showActionOptions(actionId, actionName) {
        const options = `
        <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center gap-2 mb-2">
                <i class="fas fa-magic text-blue-600"></i>
                <span class="font-medium text-blue-800">Action Selected: ${actionName}</span>
            </div>
            <div class="flex gap-2">
                <button onclick="createStateWithAction('${actionId}', '${actionName}')" class="btn btn-sm bg-blue-600 text-white hover:bg-blue-700">
                    <i class="fas fa-plus mr-1"></i>Create State
                </button>
                <button onclick="clearActionSelection()" class="btn btn-sm btn-outline">
                    <i class="fas fa-times mr-1"></i>Clear
                </button>
            </div>
        </div>
    `;

        // Remove existing action options
        const existingOptions = document.querySelector('.action-options');
        if (existingOptions) {
            existingOptions.remove();
        }

        // Add new options
        const actionLibrary = document.getElementById('actionLibrary');
        const optionsDiv = document.createElement('div');
        optionsDiv.className = 'action-options';
        optionsDiv.innerHTML = options;
        actionLibrary.appendChild(optionsDiv);
    }

    // Create state with pre-selected action
    function createStateWithAction(actionId, actionName) {
        // First create the state
        addState();

        // Store the action for later use when the state editor opens
        window.pendingActionForNewState = { id: actionId, name: actionName };

        showNotification(`Creating state with ${actionName} action`, 'success');
        clearActionSelection();
    }

    // Clear action selection
    function clearActionSelection() {
        document.querySelectorAll('.action-item').forEach(item => {
            item.classList.remove('selected-action');
            item.style.background = 'white';
            item.style.borderColor = '#e5e7eb';
        });

        const options = document.querySelector('.action-options');
        if (options) {
            options.remove();
        }

        window.selectedAction = null;
    }

    // Enhanced flow saving with better UX
    function saveFlow() {
        const saveBtn = document.querySelector('button[onclick="saveFlow()"]');
        const originalText = saveBtn.innerHTML;

        // Show loading state
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
        saveBtn.disabled = true;

        const flowData = {
            id: {{ flow.id }}
    ,
    name: document.getElementById('flowName').value,
        description: document.getElementById('flowDescription').value,
            is_active: document.getElementById('flowActive').checked,
                states: collectStatesData(),
                    transitions: collectTransitionsData()
    };

    console.log('Saving flow data:', flowData);

    fetch(`/admin/flows/{{ flow.id }}/save`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(flowData)
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Save response:', data);
            if (data.success) {
                showNotification('Flow saved successfully!', 'success');
                // Animate save button success
                saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Saved!';
                saveBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';

                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.style.background = '';
                    saveBtn.disabled = false;
                }, 2000);
            } else {
                showNotification('Error saving flow: ' + (data.error || 'Unknown error'), 'error');
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Save error:', error);
            showNotification('Error saving flow: ' + error.message, 'error');
            saveBtn.innerHTML = originalText;
            saveBtn.disabled = false;
        });
}

    function collectStatesData() {
        const states = [];
        const stateNodes = document.querySelectorAll('.state-node');

        stateNodes.forEach(node => {
            const stateId = node.dataset.stateId;
            const rect = node.getBoundingClientRect();
            const canvas = document.getElementById('flowCanvas').getBoundingClientRect();

            // Get state info from the displayed node
            const nameElement = node.querySelector('.state-title');
            const messageElement = node.querySelector('.state-message');
            const typeElement = node.querySelector('.state-type');

            states.push({
                id: stateId,
                name: nameElement ? nameElement.textContent : 'Unnamed State',
                message_body: messageElement ? messageElement.textContent : '',
                state_type: typeElement ? typeElement.textContent.replace(' ', '_').toUpperCase() : 'SEND_MESSAGE',
                is_start_state: node.classList.contains('start-state'),
                x: parseInt(node.style.left) || 0,
                y: parseInt(node.style.top) || 0,
                // Store any pending changes that haven't been saved yet
                ...window.pendingStateChanges?.[stateId] || {}
            });
        });

        console.log('Collected states:', states);
        return states;
    }

    function collectTransitionsData() {
        // Collect transitions data - this would be more complex in a real implementation
        return [];
    }

    // Enhanced auto layout with animation
    function autoLayout() {
        const states = document.querySelectorAll('.state-node');
        if (states.length === 0) return;

        const cols = Math.min(Math.ceil(Math.sqrt(states.length)), 4);
        const startX = 80;
        const startY = 80;
        const spacingX = 280;
        const spacingY = 200;

        states.forEach((state, index) => {
            const row = Math.floor(index / cols);
            const col = index % cols;
            const newX = startX + (col * spacingX);
            const newY = startY + (row * spacingY);

            // Animate to new position
            state.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            state.style.left = newX + 'px';
            state.style.top = newY + 'px';

            // Add stagger delay
            state.style.transitionDelay = (index * 100) + 'ms';

            // Remove transition delay after animation
            setTimeout(() => {
                state.style.transitionDelay = '0ms';
            }, 1000 + (index * 100));
        });

        showNotification('Layout optimized', 'success');
        updateMinimap();
    }

    // Fit all states to screen
    function fitToScreen() {
        const states = document.querySelectorAll('.state-node');
        if (states.length === 0) return;

        let minX = Infinity, minY = Infinity, maxX = 0, maxY = 0;

        states.forEach(state => {
            const x = parseInt(state.style.left);
            const y = parseInt(state.style.top);

            minX = Math.min(minX, x);
            minY = Math.min(minY, y);
            maxX = Math.max(maxX, x + 220); // state width
            maxY = Math.max(maxY, y + 120); // state height
        });

        const canvas = document.getElementById('flowCanvas');
        const canvasRect = canvas.getBoundingClientRect();

        const contentWidth = maxX - minX;
        const contentHeight = maxY - minY;

        const scaleX = (canvasRect.width - 100) / contentWidth;
        const scaleY = (canvasRect.height - 100) / contentHeight;
        const scale = Math.min(scaleX, scaleY, 1); // Don't zoom in, only out

        currentZoom = scale;
        canvas.style.transform = `scale(${scale})`;
        updateZoomDisplay();

        showNotification('Fit to screen', 'success');
    }

    // Center view on canvas
    function centerView() {
        const canvas = document.getElementById('flowCanvas');
        canvas.scrollLeft = canvas.scrollWidth / 2 - canvas.clientWidth / 2;
        canvas.scrollTop = canvas.scrollHeight / 2 - canvas.clientHeight / 2;

        showNotification('View centered', 'info');
    }

    // Enhanced zoom with smooth transitions
    function zoomIn() {
        currentZoom = Math.min(currentZoom * 1.2, 2.5);
        applyZoom();
    }

    function zoomOut() {
        currentZoom = Math.max(currentZoom / 1.2, 0.25);
        applyZoom();
    }

    function applyZoom() {
        const canvas = document.getElementById('flowCanvas');
        canvas.style.transition = 'transform 0.3s ease';
        canvas.style.transform = `scale(${currentZoom})`;

        updateZoomDisplay();

        setTimeout(() => {
            canvas.style.transition = '';
        }, 300);
    }

    function updateZoomDisplay() {
        const zoomDisplay = document.getElementById('zoomLevel');
        if (zoomDisplay) {
            zoomDisplay.textContent = Math.round(currentZoom * 100) + '%';
        }
    }

    // Enhanced dragging system
    function makeStateDraggable(element) {
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };

        // Mouse events
        element.addEventListener('mousedown', function (e) {
            if (e.target.closest('button')) return; // Don't drag when clicking buttons

            isDragging = true;
            const rect = element.getBoundingClientRect();

            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            element.style.zIndex = '1000';
            element.style.cursor = 'grabbing';
            selectState(element);

            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', handleDragEnd);

            e.preventDefault();
        });

        // Touch events for mobile
        element.addEventListener('touchstart', function (e) {
            if (e.target.closest('button')) return;

            isDragging = true;
            const rect = element.getBoundingClientRect();
            const touch = e.touches[0];

            dragOffset.x = touch.clientX - rect.left;
            dragOffset.y = touch.clientY - rect.top;

            element.style.zIndex = '1000';
            selectState(element);

            document.addEventListener('touchmove', handleTouchDrag, { passive: false });
            document.addEventListener('touchend', handleTouchDragEnd);

            e.preventDefault();
        });

        function handleDrag(e) {
            if (!isDragging) return;

            const canvas = document.getElementById('flowCanvas');
            const canvasRect = canvas.getBoundingClientRect();

            let x = e.clientX - canvasRect.left - dragOffset.x;
            let y = e.clientY - canvasRect.top - dragOffset.y;

            // Snap to grid
            x = Math.round(x / 10) * 10;
            y = Math.round(y / 10) * 10;

            // Keep within bounds
            x = Math.max(10, Math.min(x, canvasRect.width - 230));
            y = Math.max(10, Math.min(y, canvasRect.height - 130));

            element.style.left = x + 'px';
            element.style.top = y + 'px';

            updateMinimap();
        }

        function handleDragEnd() {
            isDragging = false;
            element.style.zIndex = '10';
            element.style.cursor = 'move';

            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', handleDragEnd);
        }

        function handleTouchDrag(e) {
            if (!isDragging) return;

            const canvas = document.getElementById('flowCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const touch = e.touches[0];

            let x = touch.clientX - canvasRect.left - dragOffset.x;
            let y = touch.clientY - canvasRect.top - dragOffset.y;

            // Snap to grid
            x = Math.round(x / 10) * 10;
            y = Math.round(y / 10) * 10;

            // Keep within bounds
            x = Math.max(10, Math.min(x, canvasRect.width - 230));
            y = Math.max(10, Math.min(y, canvasRect.height - 130));

            element.style.left = x + 'px';
            element.style.top = y + 'px';

            updateMinimap();
            e.preventDefault();
        }

        function handleTouchDragEnd() {
            isDragging = false;
            element.style.zIndex = '10';

            document.removeEventListener('touchmove', handleTouchDrag);
            document.removeEventListener('touchend', handleTouchDragEnd);
        }
    }

    // Make existing states draggable
    function makeCanvasDraggable(canvas) {
        const states = canvas.querySelectorAll('.state-node');
        states.forEach(makeStateDraggable);
    }

    // Enhanced event listeners and interactions
    function setupEventListeners() {
        // Close modals when clicking outside
        window.onclick = function (event) {
            const stateModal = document.getElementById('stateEditorModal');
            const transitionModal = document.getElementById('transitionEditorModal');

            if (event.target === stateModal) {
                hideStateEditor();
            }
            if (event.target === transitionModal) {
                hideTransitionEditor();
            }
        };

        // Enhanced keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            // Delete selected state with Delete key
            if (e.key === 'Delete' && selectedState) {
                const stateId = selectedState.getAttribute('data-state-id');
                deleteState(stateId);
            }

            // Escape to close modals
            if (e.key === 'Escape') {
                hideStateEditor();
                hideTransitionEditor();
                clearActionSelection();
            }

            // Ctrl+S to save
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveFlow();
            }

            // Space to center view
            if (e.key === ' ' && !e.target.matches('input, textarea')) {
                e.preventDefault();
                centerView();
            }

            // Quick actions
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                addState();
            }

            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                addDecisionState();
            }

            if (e.ctrlKey && e.key === 'a') {
                e.preventDefault();
                toggleActionLibrary();
            }
        });
    }

    // State selection system
    function selectState(stateElement) {
        clearStateSelection();
        selectedState = stateElement;
        stateElement.classList.add('selected');
    }

    function selectStateById(stateId) {
        const stateElement = document.getElementById(`state-${stateId}`);
        if (stateElement) {
            selectState(stateElement);
        }
    }

    function clearStateSelection() {
        if (selectedState) {
            selectedState.classList.remove('selected');
            selectedState = null;
        }
    }

    // Notification system
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;

        const colors = {
            success: 'bg-green-500 text-white',
            error: 'bg-red-500 text-white',
            info: 'bg-blue-500 text-white',
            warning: 'bg-yellow-500 text-white'
        };

        notification.className += ' ' + colors[type];
        notification.innerHTML = `
        <div class="flex items-center gap-2">
            <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
            ${message}
        </div>
    `;

        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
            notification.style.opacity = '1';
        }, 10);

        // Auto remove
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Minimap functionality
    function updateMinimap() {
        const canvas = document.getElementById('flowCanvas');
        const minimap = document.getElementById('minimapContent');
        const states = canvas.querySelectorAll('.state-node');

        if (!minimap) return;

        minimap.innerHTML = '';

        states.forEach(state => {
            const minimapState = document.createElement('div');
            minimapState.style.cssText = `
            position: absolute;
            width: 8px;
            height: 8px;
            background: #3b82f6;
            border-radius: 2px;
            left: ${parseInt(state.style.left) / 20}px;
            top: ${parseInt(state.style.top) / 20}px;
        `;

            if (state.classList.contains('start-state')) {
                minimapState.style.background = '#10b981';
            }

            minimap.appendChild(minimapState);
        });
    }

    // Connection handling (placeholder for future enhancement)
    function setupConnectionHandlers() {
        console.log('Connection handlers ready');
    }

    function drawExistingConnections() {
        jsPlumb.ready(function() {
            jsPlumb.setContainer("flowCanvas");

            // Suspend drawing to improve performance
            jsPlumb.batch(function() {
                // Add endpoints for each state
                const states = document.querySelectorAll('.state-node');
                states.forEach(state => {
                    jsPlumb.addEndpoint(state, {
                        anchor: "Right",
                        isSource: true,
                        connector: ["Flowchart", { cornerRadius: 5 }],
                        endpoint: "Dot",
                        paintStyle: { fill: "#3b82f6" }
                    });
                    jsPlumb.addEndpoint(state, {
                        anchor: "Left",
                        isTarget: true,
                        connector: ["Flowchart", { cornerRadius: 5 }],
                        endpoint: "Dot",
                        paintStyle: { fill: "#10b981" }
                    });
                });

                // Draw connections for each transition
                {% for state in flow.states %}
                    {% for transition in state.outgoing_transitions %}
                        jsPlumb.connect({
                            source: "state-{{ state.id }}",
                            target: "state-{{ transition.target_state_id }}",
                            anchors: ["Right", "Left"],
                            paintStyle: { stroke: "#6b7280", strokeWidth: 2 },
                            endpoint: "Blank",
                            overlays: [
                                ["Arrow", { location: 1, width: 10, length: 10 }]
                            ]
                        });
                    {% endfor %}
                {% endfor %}
            });
        });
    }

    // Transition editor functions
    function hideTransitionEditor() {
        const modal = document.getElementById('transitionEditorModal');
        modal.classList.add('hidden');
    }

    // Show keyboard shortcuts
    function showKeyboardShortcuts() {
        const shortcuts = `
        <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" onclick="this.remove()">
            <div class="bg-white rounded-xl p-6 max-w-md mx-4 shadow-2xl" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-gray-900">Keyboard Shortcuts</h3>
                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span>Save Flow</span>
                        <kbd class="bg-gray-100 px-2 py-1 rounded">Ctrl+S</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span>Add Message State</span>
                        <kbd class="bg-gray-100 px-2 py-1 rounded">Ctrl+N</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span>Add Decision State</span>
                        <kbd class="bg-gray-100 px-2 py-1 rounded">Ctrl+D</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span>Toggle Action Library</span>
                        <kbd class="bg-gray-100 px-2 py-1 rounded">Ctrl+A</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span>Delete Selected State</span>
                        <kbd class="bg-gray-100 px-2 py-1 rounded">Delete</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span>Center View</span>
                        <kbd class="bg-gray-100 px-2 py-1 rounded">Space</kbd>
                    </div>
                    <div class="flex justify-between">
                        <span>Close Modals</span>
                        <kbd class="bg-gray-100 px-2 py-1 rounded">Escape</kbd>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t text-xs text-gray-500">
                    Tip: Drag states to reposition them. Click state handles to connect them.
                </div>
            </div>
        </div>
    `;
        document.body.insertAdjacentHTML('beforeend', shortcuts);
    }
</script>
{% endblock %}