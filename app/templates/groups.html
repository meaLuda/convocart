{% extends "base.html" %}

{% block title %}Manage Groups | ConvoCart{% endblock %}

{% block page_title %}Groups{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Groups</h1>
        
        <div class="flex space-x-2">
            <a href="/admin/groups/new" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                Add New Group
            </a>
            {% if admin.role.value == 'super_admin' %}
            <a href="/admin/groups/link-generator" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">
                Generate Links
            </a>
            {% endif %}
        </div>
    </div>
    <div class="mb-6">
        <form method="GET" action="/admin/groups">
            <div class="flex">
                <input type="text" name="search" class="w-full px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Search by name or identifier" value="{{ search_query or '' }}">
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-r-md hover:bg-blue-700">Search</button>
            </div>
        </form>
    </div>
    
    {% if categories %}
    <div class="mb-6">
        <div class="flex space-x-2 flex-wrap">
            <a href="/admin/groups" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 {% if not category_filter %}font-bold{% endif %} mb-2">
                All Categories
            </a>
            {% for cat in categories %}
            <a href="/admin/groups?category={{ cat }}" class="px-3 py-1 bg-blue-100 rounded hover:bg-blue-200 {% if category_filter == cat %}font-bold{% endif %} mb-2">
                {{ cat }}
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- DataTables Groups Table -->
    <div class="overflow-x-auto">
        <table id="groups-table" class="w-full table-auto">
            <thead>
                <tr>
                    <th>Group</th>
                    <th>Identifier</th>
                    <th>Type</th>
                    <th>Statistics</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- DataTables will populate this automatically -->
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Initialize DataTables for Groups
    const groupsTable = $('#groups-table').DataTable({
        processing: true,
        serverSide: true,
        ajax: {
            url: '/api/datatables/groups',
            type: 'GET'
        },
        responsive: true,
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100], [10, 25, 50, 100]],
        columns: [
            { 
                data: 0, 
                title: 'Group',
                width: '25%'
            },
            { 
                data: 1, 
                title: 'Identifier',
                width: '15%'
            },
            { 
                data: 2, 
                title: 'Type',
                width: '15%'
            },
            { 
                data: 3, 
                title: 'Statistics',
                width: '15%'
            },
            { 
                data: 4, 
                title: 'Created',
                width: '15%'
            },
            { 
                data: 5, 
                title: 'Actions',
                width: '15%',
                orderable: false,
                searchable: false
            }
        ],
        dom: 'Bfrtip',
        buttons: [
            {
                extend: 'copy',
                text: '<i class="fas fa-copy mr-2"></i>Copy',
                className: 'dt-button'
            },
            {
                extend: 'csv',
                text: '<i class="fas fa-file-csv mr-2"></i>CSV',
                className: 'dt-button',
                title: 'Groups_Export_' + new Date().toISOString().slice(0,10)
            },
            {
                extend: 'excel',
                text: '<i class="fas fa-file-excel mr-2"></i>Excel',
                className: 'dt-button',
                title: 'Groups_Export_' + new Date().toISOString().slice(0,10)
            },
            {
                extend: 'pdf',
                text: '<i class="fas fa-file-pdf mr-2"></i>PDF',
                className: 'dt-button',
                title: 'Groups Export',
                orientation: 'landscape'
            }
        ],
        order: [[0, 'asc']], // Sort by group name
        language: {
            processing: '<i class="fas fa-spinner fa-spin mr-2"></i>Loading groups...',
            search: 'Search groups:',
            lengthMenu: 'Show _MENU_ groups per page',
            info: 'Showing _START_ to _END_ of _TOTAL_ groups',
            infoEmpty: 'No groups available',
            infoFiltered: '(filtered from _MAX_ total groups)',
            emptyTable: 'No groups found'
        },
        drawCallback: function(settings) {
            // Re-bind event handlers after table redraw
            bindGroupActions();
        }
    });

    // Function to bind group action handlers
    function bindGroupActions() {
        // Delete group button handler
        $('.delete-group-btn').off('click').on('click', function(e) {
            e.preventDefault();
            const groupId = $(this).data('group-id');
            
            if (confirm('Are you sure you want to delete this group? This action cannot be undone.')) {
                // AJAX call to delete group
                $.ajax({
                    url: `/admin/groups/${groupId}/delete`,
                    method: 'POST',
                    data: {
                        csrf_token: getCsrfToken()
                    },
                    success: function(response) {
                        ToastManager.success('Group deleted successfully');
                        groupsTable.ajax.reload(null, false);
                    },
                    error: function(xhr) {
                        ToastManager.error('Failed to delete group');
                    }
                });
            }
        });
        
        // Copy link functionality
        $('.copy-link-btn').off('click').on('click', function(e) {
            e.preventDefault();
            const link = $(this).data('link');
            
            // Copy to clipboard
            navigator.clipboard.writeText(link).then(function() {
                ToastManager.success('WhatsApp link copied to clipboard');
            }).catch(function() {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = link;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                ToastManager.success('WhatsApp link copied to clipboard');
            });
        });
    }

    // Business type filter buttons
    const typeFilters = `
        <div class="mb-4 flex flex-wrap gap-2">
            <button class="type-filter-btn px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 font-bold" data-type="">
                All Types
            </button>
            <button class="type-filter-btn px-3 py-1 bg-blue-100 rounded hover:bg-blue-200" data-type="restaurant">
                Restaurant
            </button>
            <button class="type-filter-btn px-3 py-1 bg-green-100 rounded hover:bg-green-200" data-type="retail">
                Retail
            </button>
            <button class="type-filter-btn px-3 py-1 bg-purple-100 rounded hover:bg-purple-200" data-type="service">
                Service
            </button>
            <button class="type-filter-btn px-3 py-1 bg-yellow-100 rounded hover:bg-yellow-200" data-type="other">
                Other
            </button>
        </div>
    `;
    
    // Insert type filters before the table
    $(typeFilters).insertBefore('#groups-table_wrapper');

    // Type filter functionality
    $('.type-filter-btn').on('click', function(e) {
        e.preventDefault();
        const type = $(this).data('type');
        
        // Add custom search for type
        if (type) {
            groupsTable.search(type).draw();
        } else {
            groupsTable.search('').draw();
        }
        
        // Update active button
        $('.type-filter-btn').removeClass('font-bold bg-blue-200');
        $(this).addClass('font-bold bg-blue-200');
    });

    // Initialize handlers
    bindGroupActions();
});
</script>
{% endblock %}